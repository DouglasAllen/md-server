<h1 id="the-ruby-programming-language">The Ruby Programming Language</h1>
<h2 id="chapter-5">CHAPTER 5</h2>
<h3 id="statements-and-control-structures">Statements and Control Structures</h3>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">x = <span class="dt">ARGV</span>[<span class="dv">0</span>].to_f  <span class="co"># Convert first argument to a number</span>
y = <span class="dt">ARGV</span>[<span class="dv">1</span>].to_f  <span class="co"># Convert second argument to a number</span>
sum = x + y       <span class="co"># Add the arguments</span>
puts sum          <span class="co"># Print the sum</span></code></pre></div>
<h4 id="if">5.1.1 if</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">if</span> &lt;replaceable&gt;expression&lt;<span class="ot">/replaceable&gt;</span>
<span class="ot">  &lt;replaceable&gt;code&lt;/</span>replaceable&gt;
<span class="kw">end</span>

<span class="co"># If x is less than 10, increment it</span>
<span class="kw">if</span> x &lt; <span class="dv">10</span>                     <span class="co"># newline separator</span>
  x += <span class="dv">1</span>
<span class="kw">end</span>
<span class="kw">if</span> x &lt; <span class="dv">10</span> <span class="kw">then</span> x += <span class="dv">1</span> <span class="kw">end</span>     <span class="co"># then separator</span>

<span class="kw">if</span> x &lt; <span class="dv">10</span> <span class="kw">then</span>
  x += <span class="dv">1</span>
<span class="kw">end</span></code></pre></div>
<h4 id="else">5.1.1.1 else</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">if</span> &lt;replaceable&gt;expression&lt;<span class="ot">/replaceable&gt;</span>
<span class="ot">  &lt;replaceable&gt;code&lt;/</span>replaceable&gt;
<span class="kw">else</span>
  &lt;replaceable&gt;code&lt;<span class="ot">/replaceable&gt;</span>
<span class="ot">end</span>

<span class="ot">if data         # If the array exists</span>
<span class="ot">  data &lt;&lt; x     #   then append a value to it.</span>
<span class="ot">else            # Otherwise...</span>
<span class="ot">  data = [x]    #   create a new array that holds the value.</span>
<span class="ot">end             # This is the end of the conditional.</span></code></pre></div>
<h4 id="elsif">5.1.1.2 elsif</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">if</span> &lt;replaceable&gt;expression1&lt;<span class="ot">/replaceable&gt;</span>
<span class="ot">  &lt;replaceable&gt;code1&lt;/</span>replaceable&gt;
<span class="kw">elsif</span> &lt;replaceable&gt;expression2&lt;<span class="ot">/replaceable&gt;</span>
<span class="ot">  &lt;replaceable&gt;code2&lt;/</span>replaceable&gt;
      .
      .
      .
<span class="kw">elsif</span> &lt;replaceable&gt;expressionN&lt;<span class="ot">/replaceable&gt;</span>
<span class="ot">  &lt;replaceable&gt;codeN&lt;/</span>replaceable&gt;
<span class="kw">else</span>
  &lt;replaceable&gt;code&lt;<span class="ot">/replaceable&gt;</span>
<span class="ot">end</span>

<span class="ot">if x == 1</span>
<span class="ot">  name = &quot;one&quot;</span>
<span class="ot">elsif x == 2</span>
<span class="ot">  name = &quot;two&quot;</span>
<span class="ot">elsif x == 3 then name = &quot;three&quot;</span>
<span class="ot">elsif x == 4; name = &quot;four&quot;</span>
<span class="ot">else</span>
<span class="ot">  name = &quot;many&quot;</span>
<span class="ot">end</span></code></pre></div>
<h4 id="return-value">5.1.1.3 Return value</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">name <span class="kw">= if</span>    x == <span class="dv">1</span> <span class="kw">then</span> <span class="st">&quot;one&quot;</span>
       <span class="kw">elsif</span> x == <span class="dv">2</span> <span class="kw">then</span> <span class="st">&quot;two&quot;</span>
       <span class="kw">elsif</span> x == <span class="dv">3</span> <span class="kw">then</span> <span class="st">&quot;three&quot;</span>
       <span class="kw">elsif</span> x == <span class="dv">4</span> <span class="kw">then</span> <span class="st">&quot;four&quot;</span>
       <span class="kw">else</span>              <span class="st">&quot;many&quot;</span>
       <span class="kw">end</span></code></pre></div>
<h4 id="if-as-a-modifier">5.1.2 if As a Modifier</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">if</span> &lt;replaceable&gt;expression&lt;<span class="ot">/replaceable&gt; then &lt;replaceable&gt;code&lt;/</span>replaceable&gt; <span class="kw">end</span>

&lt;replaceable&gt;code&lt;<span class="ot">/replaceable&gt; if &lt;replaceable&gt;expression&lt;/</span>replaceable&gt;

puts message <span class="kw">if</span> message    <span class="co"># Output message, if it is defined</span>

puts message        <span class="co"># Unconditional</span>
<span class="kw">if</span> message          <span class="co"># Incomplete!</span>

y = x.invert <span class="kw">if</span> x.respond_to? <span class="st">:invert</span>
y = (x.invert <span class="kw">if</span> x.respond_to? <span class="st">:invert</span>)

<span class="kw">if</span> expression     <span class="kw">begin</span>                (
  line1             line1                line1
  line2             line2                line2
<span class="kw">end</span>               <span class="kw">end</span> <span class="kw">if</span> expression    ) <span class="kw">end</span> <span class="kw">if</span> expression

<span class="co"># Output message if message exists and the output method is defined</span>
puts message <span class="kw">if</span> message <span class="kw">if</span> <span class="kw">defined?</span> puts

puts message <span class="kw">if</span> message <span class="kw">and</span> <span class="kw">defined?</span> puts</code></pre></div>
<h4 id="unless">5.1.3 unless</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># single-way unless statement</span>
<span class="kw">unless</span> &lt;replaceable&gt;condition&lt;<span class="ot">/replaceable&gt;</span>
<span class="ot">  &lt;replaceable&gt;code&lt;/</span>replaceable&gt;
<span class="kw">end</span>

<span class="co"># two-way unless statement</span>
<span class="kw">unless</span> &lt;replaceable&gt;condition&lt;<span class="ot">/replaceable&gt;</span>
<span class="ot">  &lt;replaceable&gt;code&lt;/</span>replaceable&gt;
<span class="kw">else</span>
  &lt;replaceable&gt;code&lt;<span class="ot">/replaceable&gt;</span>
<span class="ot">end</span>

<span class="ot"># unless modifier</span>
<span class="ot">&lt;replaceable&gt;code&lt;/</span>replaceable&gt; <span class="kw">unless</span> &lt;replaceable&gt;condition&lt;<span class="ot">/replaceable&gt;</span>

<span class="ot"># Call the to_s method on object o, unless o is nil</span>
<span class="ot">s = unless o.nil?                        # newline separator</span>
<span class="ot">  o.to_s</span>
<span class="ot">end</span>
<span class="ot">s = unless o.nil? then o.to_s end        # then separator</span>

<span class="ot">s = o.to_s unless o.nil?</span>

<span class="ot">unless x == 0</span>
<span class="ot">  puts &quot;x is not 0&quot;</span>
<span class="ot">else</span>
<span class="ot">  unless y == 0</span>
<span class="ot">    puts &quot;y is not 0&quot;</span>
<span class="ot">  else</span>
<span class="ot">    unless z == 0</span>
<span class="ot">      puts &quot;z is not 0&quot;</span>
<span class="ot">    else</span>
<span class="ot">      puts &quot;all are 0&quot;</span>
<span class="ot">    end</span>
<span class="ot">  end</span>
<span class="ot">end</span></code></pre></div>
<h4 id="case">5.1.4 case</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">name = <span class="kw">case</span>                           name <span class="kw">= if</span>    x == <span class="dv">1</span> <span class="kw">then</span> <span class="st">&quot;one&quot;</span>
       <span class="kw">when</span> x == <span class="dv">1</span> <span class="kw">then</span> <span class="st">&quot;one&quot;</span>                <span class="kw">elsif</span> x == <span class="dv">2</span> <span class="kw">then</span> <span class="st">&quot;two&quot;</span>
       <span class="kw">when</span> x == <span class="dv">2</span> <span class="kw">then</span> <span class="st">&quot;two&quot;</span>                <span class="kw">elsif</span> x == <span class="dv">3</span> <span class="kw">then</span> <span class="st">&quot;three&quot;</span>
       <span class="kw">when</span> x == <span class="dv">3</span> <span class="kw">then</span> <span class="st">&quot;three&quot;</span>              <span class="kw">elsif</span> x == <span class="dv">4</span> <span class="kw">then</span> <span class="st">&quot;four&quot;</span>
       <span class="kw">when</span> x == <span class="dv">4</span> <span class="kw">then</span> <span class="st">&quot;four&quot;</span>               <span class="kw">else</span> <span class="st">&quot;many&quot;</span>
       <span class="kw">else</span> <span class="st">&quot;many&quot;</span>                           <span class="kw">end</span>
       <span class="kw">end</span>

<span class="kw">case</span> 
<span class="kw">when</span> x == <span class="dv">1</span>
  <span class="st">&quot;one&quot;</span>
<span class="kw">when</span> x == <span class="dv">2</span> 
  <span class="st">&quot;two&quot;</span>
<span class="kw">when</span> x == <span class="dv">3</span>
  <span class="st">&quot;three&quot;</span>
<span class="kw">end</span>

<span class="kw">case</span>
<span class="kw">when</span> x == <span class="dv">1</span>, y == <span class="dv">0</span> <span class="kw">then</span>  <span class="st">&quot;x is one or y is zero&quot;</span>  <span class="co"># Obscure syntax</span>
<span class="kw">when</span> x == <span class="dv">2</span> || y == <span class="dv">1</span> <span class="kw">then</span> <span class="st">&quot;x is two or y is one&quot;</span>  <span class="co"># Easier to understand</span>
<span class="kw">end</span>

name = <span class="kw">case</span> x
       <span class="kw">when</span> <span class="dv">1</span>             <span class="co"># Just the value to compare to x</span>
         <span class="st">&quot;one&quot;</span>
       <span class="kw">when</span> <span class="dv">2</span> <span class="kw">then</span> <span class="st">&quot;two&quot;</span>  <span class="co"># Then keyword instead of newline</span>
       <span class="kw">when</span> <span class="dv">3</span>; <span class="st">&quot;three&quot;</span>    <span class="co"># Semicolon instead of newline</span>
       <span class="kw">else</span> <span class="st">&quot;many&quot;</span>        <span class="co"># Optional else clause at end</span>
       <span class="kw">end</span>

name = <span class="kw">case</span>
       <span class="kw">when</span> <span class="dv">1</span> === x <span class="kw">then</span> <span class="st">&quot;one&quot;</span>
       <span class="kw">when</span> <span class="dv">2</span> === x <span class="kw">then</span> <span class="st">&quot;two&quot;</span>
       <span class="kw">when</span> <span class="dv">3</span> === x <span class="kw">then</span> <span class="st">&quot;three&quot;</span>
       <span class="kw">else</span> <span class="st">&quot;many&quot;</span>
       <span class="kw">end</span>

<span class="co"># Take different actions depending on the class of x</span>
puts <span class="kw">case</span> x
     <span class="kw">when</span> <span class="dt">String</span> <span class="kw">then</span> <span class="st">&quot;string&quot;</span>
     <span class="kw">when</span> <span class="dt">Numeric</span> <span class="kw">then</span> <span class="st">&quot;number&quot;</span>
     <span class="kw">when</span> <span class="dt">TrueClass</span>, <span class="dt">FalseClass</span> <span class="kw">then</span> <span class="st">&quot;boolean&quot;</span>
     <span class="kw">else</span> <span class="st">&quot;other&quot;</span>
     <span class="kw">end</span>

<span class="co"># Compute 2006 U.S. income tax using case and Range objects</span>
tax = <span class="kw">case</span> income
      <span class="kw">when</span> <span class="dv">0</span>..<span class="dv">7550</span>
        income * <span class="fl">0.1</span>
      <span class="kw">when</span> <span class="dv">7550</span>..<span class="dv">30650</span>
        <span class="dv">755</span> + (income<span class="dv">-7550</span>)*<span class="fl">0.15</span>
      <span class="kw">when</span> <span class="dv">30650</span>..<span class="dv">74200</span>
        <span class="dv">4220</span> + (income<span class="dv">-30655</span>)*<span class="fl">0.25</span>
      <span class="kw">when</span> <span class="dv">74200</span>..<span class="dv">154800</span>
        <span class="fl">15107.5</span> + (income<span class="dv">-74201</span>)*<span class="fl">0.28</span>
      <span class="kw">when</span> <span class="dv">154800</span>..<span class="dv">336550</span>
        <span class="fl">37675.5</span> + (income<span class="dv">-154800</span>)*<span class="fl">0.33</span>
      <span class="kw">else</span>
        <span class="dv">97653</span> + (income<span class="dv">-336550</span>)*<span class="fl">0.35</span>
      <span class="kw">end</span>

<span class="co"># Get user&#39;s input and process it, ignoring comments and exiting</span>
<span class="co"># when the user enters the word &quot;quit&quot;</span>
while line=gets.chomp <span class="kw">do</span>  <span class="co"># Loop, asking the user for input each time</span>
  <span class="kw">case</span> line
  <span class="kw">when</span> <span class="ot">/^\s*#/</span>            <span class="co"># If input looks like a comment...</span>
      <span class="kw">next</span>                <span class="co">#   skip to the next line.</span>
  <span class="kw">when</span> <span class="ot">/^quit$/i</span>          <span class="co"># If input is &quot;quit&quot; (case insensitive)...</span>
    <span class="kw">break</span>                 <span class="co">#   exit the loop.</span>
  <span class="kw">else</span>                    <span class="co"># Otherwise...</span>
    puts line.reverse     <span class="co">#   reverse the user&#39;s input and print it.</span>
  <span class="kw">end</span>
<span class="kw">end</span>

<span class="kw">def</span> hasValue?(x)         <span class="co"># Define a method named hasValue?</span>
  <span class="kw">case</span> x                 <span class="co"># Multiway conditional based on value of x</span>
  <span class="kw">when</span> <span class="dv">nil</span>, [], <span class="st">&quot;&quot;</span>, <span class="dv">0</span>    <span class="co"># if nil===x || []===x || &quot;&quot;===x || 0===x then</span>
    <span class="dv">false</span>                <span class="co">#   method return value is false</span>
  <span class="kw">else</span>                   <span class="co"># Otherwise</span>
    <span class="dv">true</span>                 <span class="co">#   method return value is true</span>
  <span class="kw">end</span>
<span class="kw">end</span></code></pre></div>
<h4 id="the-operator">5.1.5 The ?: Operator</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">def</span> how_many_messages(n) <span class="co"># Handle singular/plural </span>
  <span class="st">&quot;You have &quot;</span> + n.to_s + (n==<span class="dv">1</span> ? <span class="st">&quot; message.&quot;</span> : <span class="st">&quot; messages.&quot;</span>)
<span class="kw">end</span></code></pre></div>
<h4 id="while-and-until">5.2.1 while and until</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">x = <span class="dv">10</span>               <span class="co"># Initialize a loop counter variable</span>
while x &gt;= <span class="dv">0</span> <span class="kw">do</span>      <span class="co"># Loop while x is greater than or equal to 0</span>
  puts x             <span class="co">#   Print out the value of x</span>
  x = x - <span class="dv">1</span>          <span class="co">#   Subtract 1 from x</span>
<span class="kw">end</span>                  <span class="co"># The loop ends here</span>

<span class="co"># Count back up to 10 using an until loop</span>
x = <span class="dv">0</span>                <span class="co"># Start at 0 (instead of -1)</span>
<span class="kw">until</span> x &gt; <span class="dv">10</span> <span class="kw">do</span>      <span class="co"># Loop until x is greater than 10</span>
  puts x
  x = x + <span class="dv">1</span>
<span class="kw">end</span>                  <span class="co"># Loop ends here</span></code></pre></div>
<h4 id="while-and-until-as-modifiers">5.2.2 while and until As Modifiers</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">x = <span class="dv">0</span>                          <span class="co"># Initialize loop variable</span>
puts x = x + <span class="dv">1</span> <span class="kw">while</span> x &lt; <span class="dv">10</span>    <span class="co"># Output and increment in a single expression</span>

x = <span class="dv">0</span>
while x &lt; <span class="dv">10</span> <span class="kw">do</span> puts x = x + <span class="dv">1</span> <span class="kw">end</span>

a = [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]                 <span class="co"># Initialize an array</span>
puts a.pop <span class="kw">until</span> a.empty?   <span class="co"># Pop elements from array until empty</span>

x = <span class="dv">10</span>              <span class="co"># Initialize loop variable</span>
<span class="kw">begin</span>               <span class="co"># Start a compound expression: executed at least once</span>
  puts x            <span class="co">#   output x</span>
  x = x - <span class="dv">1</span>         <span class="co">#   decrement x</span>
<span class="kw">end</span> <span class="kw">until</span> x == <span class="dv">0</span>    <span class="co"># End compound expression and modify it with a loop</span>

x = <span class="dv">0</span>               <span class="co"># Initialize loop variable</span>
(                   <span class="co"># Start a compound expression: may be executed 0 times</span>
  puts x            <span class="co">#   output x</span>
  x = x - <span class="dv">1</span>         <span class="co">#   decrement x</span>
) <span class="kw">until</span> x == <span class="dv">0</span>      <span class="co"># End compound expression and modify it with a loop</span></code></pre></div>
<h4 id="the-forin-loop">5.2.3 The for/in Loop</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">for</span> &lt;replaceable&gt;var&lt;<span class="ot">/replaceable&gt; in &lt;replaceable&gt;collection&lt;/</span>replaceable&gt; <span class="kw">do</span>
  &lt;replaceable&gt;body&lt;<span class="ot">/replaceable&gt;</span>
<span class="ot">end</span>

<span class="ot"># Print the elements in an array</span>
<span class="ot">array = [1,2,3,4,5]</span>
<span class="ot">for element in array </span>
<span class="ot">  puts element</span>
<span class="ot">end</span>

<span class="ot"># Print the keys and values in a hash</span>
<span class="ot">hash = {:a=&gt;1, :b=&gt;2, :c=&gt;3}</span>
<span class="ot">for key,value in hash</span>
<span class="ot">  puts &quot;#{</span>key<span class="ot">} =&gt; #{</span>value<span class="ot">}&quot;</span>
<span class="ot">end</span>

<span class="ot">hash = {:a=&gt;1, :b=&gt;2, :c=&gt;3}</span>
<span class="ot">hash.each do |key,value|</span>
<span class="ot">  puts &quot;#{</span>key<span class="ot">} =&gt; #{</span>value<span class="ot">}&quot;</span>
<span class="ot">end</span></code></pre></div>
<h4 id="iterators-and-enumerable-objects">5.3 Iterators and Enumerable Objects</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="dv">3</span>.times { puts <span class="st">&quot;thank you!&quot;</span> }  <span class="co"># Express gratitude three times</span>
data.each {|x| puts x }        <span class="co"># Print each element x of data</span>
[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>].map {|x| x*x }         <span class="co"># Compute squares of array elements</span>
factorial = <span class="dv">1</span>                  <span class="co"># Compute the factorial of n</span>
<span class="dv">2</span>.upto(n) {|x| factorial *= x }

chars = <span class="st">&quot;hello world&quot;</span>.tap {|x| puts <span class="st">&quot;original object: </span><span class="ot">#{</span>x.inspect<span class="ot">}</span><span class="st">&quot;</span>}
  .each_char         .tap {|x| puts <span class="st">&quot;each_char returns: </span><span class="ot">#{</span>x.inspect<span class="ot">}</span><span class="st">&quot;</span>}
  .to_a              .tap {|x| puts <span class="st">&quot;to_a returns: </span><span class="ot">#{</span>x.inspect<span class="ot">}</span><span class="st">&quot;</span>}
  .map {|c| c.succ } .tap {|x| puts <span class="st">&quot;map returns: </span><span class="ot">#{</span>x.inspect<span class="ot">}</span><span class="st">&quot;</span> }
  .sort              .tap {|x| puts <span class="st">&quot;sort returns: </span><span class="ot">#{</span>x.inspect<span class="ot">}</span><span class="st">&quot;</span>}</code></pre></div>
<h4 id="numeric-iterators">5.3.1 Numeric Iterators</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="dv">4</span>.upto(<span class="dv">6</span>) {|x| print x}   <span class="co"># =&gt; prints &quot;456&quot;</span>

<span class="dv">3</span>.times {|x| print x }    <span class="co"># =&gt; prints &quot;012&quot;</span>

<span class="dv">0</span>.step(<span class="dt">Math</span>::<span class="dt">PI</span>, <span class="fl">0.1</span>) {|x| puts <span class="dt">Math</span>.sin(x) }</code></pre></div>
<h4 id="enumerable-objects">5.3.2 Enumerable Objects</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>].each {|x| print x }   <span class="co"># =&gt; prints &quot;123&quot;</span>
(<span class="dv">1</span>..<span class="dv">3</span>).each  {|x| print x }   <span class="co"># =&gt; prints &quot;123&quot; Same as 1.upto(3)</span>

<span class="dt">File</span>.open(filename) <span class="kw">do</span> |f|       <span class="co"># Open named file, pass as f</span>
  f.each {|line| print line }    <span class="co"># Print each line in f</span>
<span class="kw">end</span>                              <span class="co"># End block and close file</span>

<span class="dt">File</span>.open(filename) <span class="kw">do</span> |f|
  f.each_with_index <span class="kw">do</span> |line,number|
    print <span class="st">&quot;</span><span class="ot">#{</span>number<span class="ot">}</span><span class="st">: </span><span class="ot">#{</span>line<span class="ot">}</span><span class="st">&quot;</span>
  <span class="kw">end</span>
<span class="kw">end</span>

squares = [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>].collect {|x| x*x}   <span class="co"># =&gt; [1,4,9]</span>

evens = (<span class="dv">1</span>..<span class="dv">10</span>).select {|x| x%<span class="dv">2</span> == <span class="dv">0</span>} <span class="co"># =&gt; [2,4,6,8,10]</span>

odds = (<span class="dv">1</span>..<span class="dv">10</span>).reject {|x| x%<span class="dv">2</span> == <span class="dv">0</span>}  <span class="co"># =&gt; [1,3,5,7,9]</span>

data = [<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">3</span>, <span class="dv">4</span>]
sum = data.inject {|sum, x| sum + x }      <span class="co"># =&gt; 14    (2+5+3+4)</span>
floatprod = data.inject(<span class="fl">1.0</span>) {|p,x| p*x }  <span class="co"># =&gt; 120.0 (1.0*2*5*3*4)</span>
max = data.inject {|m,x| m&gt;x ? m : x }     <span class="co"># =&gt; 5     (largest element)</span></code></pre></div>
<h4 id="writing-custom-iterators">5.3.3 Writing Custom Iterators</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">def</span> twice
  <span class="kw">yield</span>
  <span class="kw">yield</span>
<span class="kw">end</span>

<span class="co"># This method expects a block. It generates n values of the form</span>
<span class="co"># m*i + c, for i from 0..n-1, and yields them, one at a time, </span>
<span class="co"># to the associated block.</span>
<span class="kw">def</span> sequence(n, m, c)
  i = <span class="dv">0</span>
  <span class="kw">while</span>(i &lt; n)      <span class="co"># Loop n times</span>
    <span class="kw">yield</span> m*i + c   <span class="co"># Invoke the block, and pass a value to it</span>
    i += <span class="dv">1</span>          <span class="co"># Increment i each time</span>
  <span class="kw">end</span>
<span class="kw">end</span>

<span class="co"># Here is an invocation of that method, with a block.</span>
<span class="co"># It prints the values 1, 6, and 11</span>
sequence(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">1</span>) {|y| puts y }

<span class="co"># Generate n points evenly spaced around the circumference of a </span>
<span class="co"># circle of radius r centered at (0,0). Yield the x and y coordinates</span>
<span class="co"># of each point to the associated block.</span>
<span class="kw">def</span> circle(r,n)
  n.times <span class="kw">do</span> |i|    <span class="co"># Notice that this method is implemented with a block</span>
    angle = <span class="dt">Math</span>::<span class="dt">PI</span> * <span class="dv">2</span> * i / n
    <span class="kw">yield</span> r*<span class="dt">Math</span>.cos(angle), r*<span class="dt">Math</span>.sin(angle)
  <span class="kw">end</span>
<span class="kw">end</span>

<span class="co"># This invocation of the iterator prints:</span>
<span class="co"># (1.00, 0.00) (0.00, 1.00) (-1.00, 0.00) (-0.00, -1.00)</span>
circle(<span class="dv">1</span>,<span class="dv">4</span>) {|x,y| printf <span class="st">&quot;(%.2f, %.2f) &quot;</span>, x, y }

<span class="co"># Return an array with n elements of the form m*i+c</span>
<span class="co"># If a block is given, also yield each element to the block</span>
<span class="kw">def</span> sequence(n, m, c)
  i, s = <span class="dv">0</span>, []                  <span class="co"># Initialize variables</span>
  <span class="kw">while</span>(i &lt; n)                  <span class="co"># Loop n times</span>
    y = m*i + c                 <span class="co"># Compute value</span>
    <span class="kw">yield</span> y <span class="kw">if</span> block_given?     <span class="co"># Yield, if block</span>
    s &lt;&lt; y                      <span class="co"># Store the value</span>
    i += <span class="dv">1</span>
  <span class="kw">end</span>
  s                             <span class="co"># Return the array of values</span>
<span class="kw">end</span></code></pre></div>
<h4 id="enumerators">5.3.4 Enumerators</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># Call this method with an Enumerator instead of a mutable array.</span>
<span class="co"># This is a useful defensive strategy to avoid bugs.</span>
process(data.to_enum)  <span class="co"># Instead of just process(data)</span>

s = <span class="st">&quot;hello&quot;</span>
s.enum_for(<span class="st">:each_char</span>).map {|c| c.succ }  <span class="co"># =&gt; [&quot;i&quot;, &quot;f&quot;, &quot;m&quot;, &quot;m&quot;, &quot;p&quot;]</span>

process(data.each_char)  <span class="co"># Instead of just process(data)</span>

<span class="st">&quot;hello&quot;</span>.chars.map {|c| c.succ }  <span class="co"># =&gt; [&quot;i&quot;, &quot;f&quot;, &quot;m&quot;, &quot;m&quot;, &quot;p&quot;]</span>

enumerator = <span class="dv">3</span>.times             <span class="co"># An enumerator object</span>
enumerator.each {|x| print x }   <span class="co"># Prints &quot;012&quot;</span>

<span class="co"># downto returns an enumerator with a select method</span>
<span class="dv">10</span>.downto(<span class="dv">1</span>).select {|x| x%<span class="dv">2</span>==<span class="dv">0</span>}  <span class="co"># =&gt; [10,8,6,4,2]</span>

<span class="co"># each_byte iterator returns an enumerator with a to_a method</span>
<span class="st">&quot;hello&quot;</span>.each_byte.to_a            <span class="co"># =&gt; [104, 101, 108, 108, 111]</span>

<span class="kw">def</span> twice
  <span class="kw">if</span> block_given?
    <span class="kw">yield</span>
    <span class="kw">yield</span>
  <span class="kw">else</span>
    <span class="dv">self</span>.to_enum(<span class="st">:twice</span>)    
  <span class="kw">end</span>
<span class="kw">end</span>

enumerator = s.each_char.with_index

<span class="kw">for</span> line, number <span class="kw">in</span> text.each_line.with_index
  print <span class="st">&quot;</span><span class="ot">#{</span>number<span class="dv">+1</span><span class="ot">}</span><span class="st">: </span><span class="ot">#{</span>line<span class="ot">}</span><span class="st">&quot;</span>
<span class="kw">end</span></code></pre></div>
<h4 id="external-iterators">5.3.5 External Iterators</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">iterator = <span class="dv">9</span>.downto(<span class="dv">1</span>)             <span class="co"># An enumerator as external iterator</span>
<span class="kw">begin</span>                              <span class="co"># So we can use rescue below</span>
  print iterator.next <span class="kw">while</span> <span class="dv">true</span>   <span class="co"># Call the next method repeatedly</span>
<span class="kw">rescue</span> <span class="dt">StopIteration</span>               <span class="co"># When there are no more values</span>
  puts <span class="st">&quot;...blastoff!&quot;</span>              <span class="co"># An expected, nonexceptional condition</span>
<span class="kw">end</span>

iterator = <span class="dv">9</span>.downto(<span class="dv">1</span>)
loop <span class="kw">do</span>                 <span class="co"># Loop until StopIteration is raised</span>
  print iterator.next   <span class="co"># Print next item</span>
<span class="kw">end</span>
puts <span class="st">&quot;...blastoff!&quot;</span>

<span class="kw">module</span> <span class="dt">Iterable</span>
  include <span class="dt">Enumerable</span>          <span class="co"># Define iterators on top of each</span>
  <span class="kw">def</span> each                    <span class="co"># And define each on top of next</span>
    loop { <span class="kw">yield</span> <span class="dv">self</span>.next }
  <span class="kw">end</span>
<span class="kw">end</span>

<span class="kw">def</span> iterate(iterator)
  loop { <span class="kw">yield</span> iterator.next }
<span class="kw">end</span>

iterate(<span class="dv">9</span>.downto(<span class="dv">1</span>)) {|x| print x }

<span class="co"># Call the each method of each collection in turn.</span>
<span class="co"># This is not a parallel iteration and does not require enumerators.</span>
<span class="kw">def</span> sequence(*enumerables, &amp;block)
  enumerables.each <span class="kw">do</span> |enumerable|
    enumerable.each(&amp;block)
  <span class="kw">end</span>
<span class="kw">end</span>

<span class="co"># Iterate the specified collections, interleaving their elements.</span>
<span class="co"># This can&#39;t be done efficiently without external iterators.</span>
<span class="co"># Note the use of the uncommon else clause in begin/rescue.</span>
<span class="kw">def</span> interleave(*enumerables)
  <span class="co"># Convert enumerable collections to an array of enumerators.</span>
  enumerators = enumerables.map {|e| e.to_enum }
  <span class="co"># Loop until we don&#39;t have any more enumerators.</span>
  <span class="kw">until</span> enumerators.empty?
    <span class="kw">begin</span>
      e = enumerators.shift   <span class="co"># Take the first enumerator</span>
      <span class="kw">yield</span> e.next            <span class="co"># Get its next and pass to the block</span>
    <span class="kw">rescue</span> <span class="dt">StopIteration</span>      <span class="co"># If no more elements, do nothing</span>
    <span class="kw">else</span>                      <span class="co"># If no exception occurred</span>
      enumerators &lt;&lt; e        <span class="co"># Put the enumerator back</span>
    <span class="kw">end</span>
  <span class="kw">end</span>
<span class="kw">end</span>

<span class="co"># Iterate the specified collections, yielding tuples of values,</span>
<span class="co"># one value from each of the collections. See also Enumerable.zip.</span>
<span class="kw">def</span> bundle(*enumerables)
  enumerators = enumerables.map {|e| e.to_enum }
  loop { <span class="kw">yield</span> enumerators.map {|e| e.next} }
<span class="kw">end</span>

<span class="co"># Examples of how these iterator methods work</span>
a,b,c = [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>], <span class="dv">4</span>..<span class="dv">6</span>, <span class="st">&#39;a&#39;</span>..<span class="st">&#39;e&#39;</span>
sequence(a,b,c) {|x| print x}   <span class="co"># prints &quot;123456abcde&quot;</span>
interleave(a,b,c) {|x| print x} <span class="co"># prints &quot;14a25b36cde&quot;</span>
bundle(a,b,c) {|x| print x}     <span class="co"># &#39;[1, 4, &quot;a&quot;][2, 5, &quot;b&quot;][3, 6, &quot;c&quot;]&#39;</span></code></pre></div>
<h4 id="iteration-and-concurrent-modification">5.3.6 Iteration and Concurrent Modification</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">a = [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>]
a.each {|x| puts <span class="st">&quot;</span><span class="ot">#{</span>x<span class="ot">}</span><span class="st">,</span><span class="ot">#{</span>a.shift<span class="ot">}</span><span class="st">&quot;</span> }  <span class="co"># prints &quot;1,1\n3,2\n5,3&quot;</span>

<span class="kw">module</span> <span class="dt">Enumerable</span>
  <span class="kw">def</span> each_in_snapshot &amp;block
    snapshot = <span class="dv">self</span>.dup    <span class="co"># Make a private copy of the Enumerable object</span>
    snapshot.each &amp;block   <span class="co"># And iterate on the copy</span>
  <span class="kw">end</span>
<span class="kw">end</span></code></pre></div>
<h4 id="block-syntax">5.4.1 Block Syntax</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># Print the numbers 1 to 10</span>
<span class="dv">1</span>.upto(<span class="dv">10</span>) {|x| puts x }   <span class="co"># Invocation and block on one line with braces</span>
<span class="dv">1</span>.upto(<span class="dv">10</span>) <span class="kw">do</span> |x|          <span class="co"># Block delimited with do/end</span>
  puts x
<span class="kw">end</span>
<span class="dv">1</span>.upto(<span class="dv">10</span>)                 <span class="co"># No block specified</span>
 {|x| puts x }             <span class="co"># Syntax error: block not after an invocation</span>

<span class="dv">1</span>.upto(<span class="dv">3</span>) {|x| puts x }    <span class="co"># Parens and curly braces work</span>
<span class="dv">1</span>.upto <span class="dv">3</span> <span class="kw">do</span> |x| puts x <span class="kw">end</span> <span class="co"># No parens, block delimited with do/end</span>
<span class="dv">1</span>.upto <span class="dv">3</span> {|x| puts x }     <span class="co"># Syntax Error: trying to pass a block to 3!</span>

<span class="co"># The Hash.each iterator passes two arguments to its block</span>
hash.each <span class="kw">do</span> |key, value|   <span class="co"># For each (key,value) pair in the hash</span>
  puts <span class="st">&quot;</span><span class="ot">#{</span>key<span class="ot">}</span><span class="st">: </span><span class="ot">#{</span>value<span class="ot">}</span><span class="st">&quot;</span>   <span class="co"># Print the key and the value</span>
<span class="kw">end</span>                         <span class="co"># End of the block</span></code></pre></div>
<h4 id="the-value-of-a-block">5.4.2 The Value of a Block</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># The block takes two words and &quot;returns&quot; their relative order</span>
words.sort! {|x,y| y &lt;=&gt; x }

array.collect <span class="kw">do</span> |x|
  <span class="kw">next</span> <span class="dv">0</span> <span class="kw">if</span> x == <span class="dv">nil</span>  <span class="co"># Return prematurely if x is nil</span>
  <span class="kw">next</span> x, x*x         <span class="co"># Return two values</span>
<span class="kw">end</span>

array.collect <span class="kw">do</span> |x|
  <span class="kw">if</span> x == <span class="dv">nil</span>
    <span class="dv">0</span>
  <span class="kw">else</span>
    [x, x*x]
  <span class="kw">end</span>
<span class="kw">end</span></code></pre></div>
<h4 id="blocks-and-variable-scope">5.4.3 Blocks and Variable Scope</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">total = <span class="dv">0</span>   
data.each {|x| total += x }  <span class="co"># Sum the elements of the data array</span>
puts total                   <span class="co"># Print out that sum</span>

<span class="dv">1</span>.upto(<span class="dv">10</span>) <span class="kw">do</span> |i|         <span class="co"># 10 rows</span>
  <span class="dv">1</span>.upto(<span class="dv">10</span>) <span class="kw">do</span> |i|       <span class="co"># Each has 10 columns</span>
    print <span class="st">&quot;</span><span class="ot">#{</span>i<span class="ot">}</span><span class="st"> &quot;</span>         <span class="co"># Print column number</span>
  <span class="kw">end</span>
  print <span class="st">&quot; ==&gt; Row </span><span class="ot">#{</span>i<span class="ot">}</span><span class="st">\n&quot;</span> <span class="co"># Try to print row number, but get column number</span>
<span class="kw">end</span>

x = y = <span class="dv">0</span>            <span class="co"># local variables</span>
<span class="dv">1</span>.upto(<span class="dv">4</span>) <span class="kw">do</span> |x;y|   <span class="co"># x and y are local to block</span>
                     <span class="co"># x and y &quot;shadow&quot; the outer variables</span>
  y = x + <span class="dv">1</span>          <span class="co"># Use y as a scratch variable</span>
  puts y*y           <span class="co"># Prints 4, 9, 16, 25</span>
<span class="kw">end</span>
[x,y]                <span class="co"># =&gt; [0,0]: block does not alter these</span>

hash.each {|key,value; i,j,k| ... }</code></pre></div>
<h4 id="passing-arguments-to-a-block">5.4.4 Passing Arguments to a Block</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">key,value = k,v

{<span class="st">:one=</span>&gt;<span class="dv">1</span>}.each_pair {|key,value| ... } <span class="co"># key=:one, value=1</span>

{<span class="st">:one=</span>&gt;<span class="dv">1</span>}.each_pair {|<span class="dt">$key</span>, <span class="ot">@value</span>| ... } <span class="co"># No longer works in Ruby 1.9</span>

hash.each {|k,v| ... }  <span class="co"># key and value assigned to params k and v</span>

k,v = [key, value]

<span class="kw">def</span> two; <span class="kw">yield</span> <span class="dv">1</span>,<span class="dv">2</span>; <span class="kw">end</span>  <span class="co"># An iterator that yields two values</span>
two {|x| p x }     <span class="co"># Ruby 1.8: warns and prints [1,2],</span>
two {|x| p x }     <span class="co"># Ruby 1.9: prints 1, no warning</span>
two {|*x| p x }    <span class="co"># Either version: prints [1,2]; no warning</span>
two {|x,| p x }    <span class="co"># Either version: prints 1; no warning</span>

<span class="kw">def</span> five; <span class="kw">yield</span> <span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>; <span class="kw">end</span>     <span class="co"># Yield 5 values</span>
five <span class="kw">do</span> |head, *body, tail|        <span class="co"># Extra values go into body array</span>
  print head, body, tail           <span class="co"># Prints &quot;1[2,3,4]5&quot;</span>
<span class="kw">end</span>

<span class="kw">def</span> hashiter; <span class="kw">yield</span> <span class="st">:a=</span>&gt;<span class="dv">1</span>, <span class="st">:b=</span>&gt;<span class="dv">2</span>; <span class="kw">end</span>  <span class="co"># Note no curly braces</span>
hashiter {|hash| puts hash[<span class="st">:a</span>] }       <span class="co"># Prints 1</span>

<span class="co"># This Proc expects a block </span>
printer = lambda {|&amp;b| puts b.call } <span class="co"># Print value returned by b</span>
printer.call { <span class="st">&quot;hi&quot;</span> }                <span class="co"># Pass a block to the block!</span>

[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>].each {|x,y=<span class="dv">10</span>| print x*y }     <span class="co"># SyntaxError!</span>

[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>].each &amp;-&gt;(x,y=<span class="dv">10</span>) { print x*y }  <span class="co"># Prints &quot;102030&quot;</span></code></pre></div>
<h4 id="return">5.5.1 return</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># Return two copies of x, if x is not nil</span>
<span class="kw">def</span> double(x)
  <span class="kw">return</span> <span class="dv">nil</span> <span class="kw">if</span> x == <span class="dv">nil</span>   <span class="co"># Return prematurely</span>
  <span class="kw">return</span> x, x.dup          <span class="co"># Return multiple values</span>
<span class="kw">end</span>

<span class="co"># Return the index of the first occurrence of target within array or nil</span>
<span class="co"># Note that this code just duplicates the Array.index method</span>
<span class="kw">def</span> find(array, target)
  array.each_with_index <span class="kw">do</span> |element,index|
    <span class="kw">return</span> index <span class="kw">if</span> (element == target)  <span class="co"># return from find</span>
  <span class="kw">end</span>
  <span class="dv">nil</span>  <span class="co"># If we didn&#39;t find the element, return nil</span>
<span class="kw">end</span></code></pre></div>
<h4 id="break">5.5.2 break</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">while</span>(line = gets.chop)     <span class="co"># A loop starts here</span>
  <span class="kw">break</span> <span class="kw">if</span> line == <span class="st">&quot;quit&quot;</span>   <span class="co"># If this break statement is executed...</span>
  puts eval(line)
<span class="kw">end</span>
puts <span class="st">&quot;Good bye&quot;</span>             <span class="co"># ...then control is transferred here</span>

f.each <span class="kw">do</span> |line|             <span class="co"># Iterate over the lines in file f</span>
  <span class="kw">break</span> <span class="kw">if</span> line == <span class="st">&quot;quit\n&quot;</span>  <span class="co"># If this break statement is executed...</span>
  puts eval(line)
<span class="kw">end</span>
puts <span class="st">&quot;Good bye&quot;</span>              <span class="co"># ...then control is transferred here</span></code></pre></div>
<h4 id="next">5.5.3 next</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">while</span>(line = gets.chop)     <span class="co"># A loop starts here</span>
  <span class="kw">next</span> <span class="kw">if</span> line[<span class="dv">0</span>,<span class="dv">1</span>] == <span class="st">&quot;#&quot;</span>  <span class="co"># If this line is a comment, go on to the next</span>
  puts eval(line)
  <span class="co"># Control goes here when the next statement is executed</span>
<span class="kw">end</span>

f.each <span class="kw">do</span> |line|              <span class="co"># Iterate over the lines in file f</span>
  <span class="kw">next</span> <span class="kw">if</span> line[<span class="dv">0</span>,<span class="dv">1</span>] == <span class="st">&quot;#&quot;</span>    <span class="co"># If this line is a comment, go to the next</span>
  puts eval(line)
  <span class="co"># Control goes here when the next statement is executed</span>
<span class="kw">end</span></code></pre></div>
<h4 id="next-and-block-value">5.5.3.1 next and block value</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">squareroots = data.collect <span class="kw">do</span> |x|
  <span class="kw">next</span> <span class="dv">0</span> <span class="kw">if</span> x &lt; <span class="dv">0</span>  <span class="co"># Return 0 for negative values</span>
  <span class="dt">Math</span>.sqrt(x)
<span class="kw">end</span>

squareroots = data.collect <span class="kw">do</span> |x|
  <span class="kw">if</span> (x &lt; <span class="dv">0</span>) <span class="kw">then</span> <span class="dv">0</span> <span class="kw">else</span> <span class="dt">Math</span>.sqrt(x) <span class="kw">end</span>
<span class="kw">end</span></code></pre></div>
<h4 id="redo">5.5.4 redo</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">i = <span class="dv">0</span>
<span class="kw">while</span>(i &lt; <span class="dv">3</span>)   <span class="co"># Prints &quot;0123&quot; instead of &quot;012&quot;</span>
  <span class="co"># Control returns here when redo is executed</span>
  print i
  i += <span class="dv">1</span>
  <span class="kw">redo</span> <span class="kw">if</span> i == <span class="dv">3</span>
<span class="kw">end</span>

puts <span class="st">&quot;Please enter the first word you think of&quot;</span>
words =<span class="ot"> %w(</span><span class="st">apple banana cherry</span><span class="ot">)</span>   <span class="co"># shorthand for [&quot;apple&quot;, &quot;banana&quot;, &quot;cherry&quot;]</span>
response = words.collect <span class="kw">do</span> |word|
  <span class="co"># Control returns here when redo is executed</span>
  print word + <span class="st">&quot;&gt; &quot;</span>               <span class="co"># Prompt the user</span>
  response = gets.chop            <span class="co"># Get a response</span>
  <span class="kw">if</span> response.size == <span class="dv">0</span>           <span class="co"># If user entered nothing</span>
    word.upcase!                  <span class="co"># Emphasize the prompt with uppercase</span>
    <span class="kw">redo</span>                          <span class="co"># And skip to the top of the block</span>
  <span class="kw">end</span>
  response                        <span class="co"># Return the response</span>
<span class="kw">end</span></code></pre></div>
<h4 id="retry">5.5.5 retry</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">n = <span class="dv">10</span>
n.times <span class="kw">do</span> |x|   <span class="co"># Iterate n times from 0 to n&amp;#x2013;1</span>
  print x        <span class="co"># Print iteration number</span>
  <span class="kw">if</span> x == <span class="dv">9</span>      <span class="co"># If we&#39;ve reached 9</span>
    n -= <span class="dv">1</span>       <span class="co"># Decrement n (we won&#39;t reach 9 the next time!)</span>
    <span class="kw">retry</span>        <span class="co"># Restart the iteration</span>
  <span class="kw">end</span>
<span class="kw">end</span>

<span class="co"># This method behaves like a while loop: if x is non-nil and non-false,</span>
<span class="co"># invoke the block and then retry to restart the loop and test the</span>
<span class="co"># condition again. This method is slightly different than a true while loop: </span>
<span class="co"># you can use C-style curly braces to delimit the loop body. And</span>
<span class="co"># variables used only within the body of the loop remain local to the block.</span>
<span class="kw">def</span> repeat_while(x)
  <span class="kw">if</span> x     <span class="co"># If the condition was not nil or false</span>
    <span class="kw">yield</span>  <span class="co"># Run the body of the loop</span>
    <span class="kw">retry</span>  <span class="co"># Retry and re-evaluate loop condition</span>
  <span class="kw">end</span>
<span class="kw">end</span></code></pre></div>
<h4 id="throw-and-catch">5.5.6 throw and catch</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">for</span> matrix <span class="kw">in</span> data <span class="kw">do</span>             <span class="co"># Process a deeply nested data structure.</span>
  catch <span class="st">:missing_data</span> <span class="kw">do</span>          <span class="co"># Label this statement so we can break out.</span>
    <span class="kw">for</span> row <span class="kw">in</span> matrix <span class="kw">do</span>
      <span class="kw">for</span> value <span class="kw">in</span> row <span class="kw">do</span>
        throw <span class="st">:missing_data</span> <span class="kw">unless</span> value <span class="co"># Break out of two loops at once.</span>
        <span class="co"># Otherwise, do some actual data processing here.</span>
      <span class="kw">end</span>
    <span class="kw">end</span>
  <span class="kw">end</span>
  <span class="co"># We end up here after the nested loops finish processing each matrix.</span>
  <span class="co"># We also get here if :missing_data is thrown.</span>
<span class="kw">end</span></code></pre></div>
<h4 id="exception-classes-and-exception-objects">5.6.1 Exception Classes and Exception Objects</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="dt">Object</span>
 +--<span class="dt">Exception</span>
     +--<span class="dt">NoMemoryError</span>
     +--<span class="dt">ScriptError</span>
     |   +--<span class="dt">LoadError</span>
     |   +--<span class="dt">NotImplementedError</span>
     |   +--<span class="dt">SyntaxError</span>
     +--<span class="dt">SecurityError</span>         <span class="co"># Was a StandardError in 1.8</span>
     +--<span class="dt">SignalException</span>
     |   +--<span class="dt">Interrupt</span>
     +--<span class="dt">SystemExit</span>
     +--<span class="dt">SystemStackError</span>      <span class="co"># Was a StandardError in 1.8</span>
     +--<span class="dt">StandardError</span>
         +--<span class="dt">ArgumentError</span>
         +--<span class="dt">FiberError</span>        <span class="co"># New in 1.9</span>
         +--<span class="dt">IOError</span>
         |   +--<span class="dt">EOFError</span>
         +--<span class="dt">IndexError</span>
         |   +--<span class="dt">KeyError</span>      <span class="co"># New in 1.9</span>
         |   +--<span class="dt">StopIteration</span> <span class="co"># New in 1.9</span>
         +--<span class="dt">LocalJumpError</span>
         +--<span class="dt">NameError</span>
         |   +--<span class="dt">NoMethodError</span>
         +--<span class="dt">RangeError</span>
         |   +--<span class="dt">FloatDomainError</span>
         +--<span class="dt">RegexpError</span>
         +--<span class="dt">RuntimeError</span>
         +--<span class="dt">SystemCallError</span>
         +--<span class="dt">ThreadError</span>
         +--<span class="dt">TypeError</span>
         +--<span class="dt">ZeroDivisionError</span></code></pre></div>
<h4 id="the-methods-of-exception-objects">5.6.1.1 The methods of exception objects</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">&lt;replaceable&gt;filename&lt;<span class="ot">/replaceable&gt; : &lt;replaceable&gt;linenumber&lt;/</span>replaceable&gt; <span class="kw">in</span> &lt;replaceable&gt;methodname&lt;<span class="ot">/replaceable&gt;</span></code></pre></div>
<h4 id="defining-new-exception-classes">5.6.1.3 Defining new exception classes</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">class</span> <span class="dt">MyError</span> &lt; <span class="dt">StandardError</span>; <span class="kw">end</span></code></pre></div>
<p>5.6.2 Raising Exceptions with raise</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">def</span> factorial(n)                 <span class="co"># Define a factorial method with argument n</span>
  raise <span class="st">&quot;bad argument&quot;</span> <span class="kw">if</span> n &lt; <span class="dv">1</span>  <span class="co"># Raise an exception for bad n</span>
  <span class="kw">return</span> <span class="dv">1</span> <span class="kw">if</span> n == <span class="dv">1</span>             <span class="co"># factorial(1) is 1</span>
  n * factorial(n<span class="dv">-1</span>)             <span class="co"># Compute other factorials recursively</span>
<span class="kw">end</span>

raise <span class="dt">RuntimeError</span>, <span class="st">&quot;bad argument&quot;</span> <span class="kw">if</span> n &lt; <span class="dv">1</span>
raise <span class="dt">RuntimeError</span>.new(<span class="st">&quot;bad argument&quot;</span>) <span class="kw">if</span> n &lt; <span class="dv">1</span>
raise <span class="dt">RuntimeError</span>.exception(<span class="st">&quot;bad argument&quot;</span>) <span class="kw">if</span> n &lt; <span class="dv">1</span>

raise <span class="dt">ArgumentError</span> <span class="kw">if</span> n &lt; <span class="dv">1</span>

raise <span class="dt">ArgumentError</span>, <span class="st">&quot;Expected argument &gt;= 1. Got </span><span class="ot">#{</span>n<span class="ot">}</span><span class="st">&quot;</span> <span class="kw">if</span> n &lt; <span class="dv">1</span>

<span class="kw">if</span> n &lt; <span class="dv">1</span>
  raise <span class="dt">ArgumentError</span>, <span class="st">&quot;Expected argument &gt;= 1. Got </span><span class="ot">#{</span>n<span class="ot">}</span><span class="st">&quot;</span>, <span class="dv">caller</span>
<span class="kw">end</span>

raise <span class="dt">TypeError</span>, <span class="st">&quot;Integer argument expected&quot;</span> <span class="kw">if</span> <span class="kw">not</span> n.is_a? <span class="dt">Integer</span></code></pre></div>
<h4 id="handling-exceptions-with-rescue">5.6.3 Handling Exceptions with rescue</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">begin</span>
  <span class="co"># Any number of Ruby statements go here.</span>
  <span class="co"># Usually, they are executed without exceptions and</span>
  <span class="co"># execution continues after the end statement.</span>
<span class="kw">rescue</span>
  <span class="co"># This is the rescue clause; exception-handling code goes here.</span>
  <span class="co"># If an exception is raised by the code above, or propagates up</span>
  <span class="co"># from one of the methods called above, then execution jumps here.</span>
<span class="kw">end</span></code></pre></div>
<h4 id="naming-the-exception-object">5.6.3.1 Naming the exception object</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">require <span class="st">&#39;English&#39;</span>

<span class="kw">rescue</span> =&gt; ex

<span class="kw">begin</span>                                <span class="co"># Handle exceptions in this block</span>
  x = factorial(-<span class="dv">1</span>)                  <span class="co"># Note illegal argument</span>
<span class="kw">rescue</span> =&gt; ex                         <span class="co"># Store exception in variable ex</span>
  puts <span class="st">&quot;</span><span class="ot">#{</span>ex.class<span class="ot">}</span><span class="st">: </span><span class="ot">#{</span>ex.message<span class="ot">}</span><span class="st">&quot;</span>  <span class="co"># Handle exception by printing message</span>
<span class="kw">end</span>                                  <span class="co"># End the begin/rescue block</span></code></pre></div>
<h4 id="handling-exceptions-by-type">5.6.3.2 Handling exceptions by type</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">rescue</span> <span class="dt">Exception</span>

<span class="kw">rescue</span> <span class="dt">ArgumentError</span> =&gt; e

<span class="kw">rescue</span> <span class="dt">ArgumentError</span>, <span class="dt">TypeError</span> =&gt; error

<span class="kw">begin</span>
  x = factorial(<span class="dv">1</span>)
<span class="kw">rescue</span> <span class="dt">ArgumentError</span> =&gt; ex
  puts <span class="st">&quot;Try again with a value &gt;= 1&quot;</span>
<span class="kw">rescue</span> <span class="dt">TypeError</span> =&gt; ex
  puts <span class="st">&quot;Try again with an integer&quot;</span>
<span class="kw">end</span></code></pre></div>
<h4 id="propagation-of-exceptions">5.6.3.3 Propagation of exceptions</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">def</span> explode        <span class="co"># This method raises a RuntimeError 10% of the time</span>
  raise <span class="st">&quot;bam!&quot;</span> <span class="kw">if</span> rand(<span class="dv">10</span>) == <span class="dv">0</span>
<span class="kw">end</span>

<span class="kw">def</span> risky   
  <span class="kw">begin</span>            <span class="co"># This block</span>
    <span class="dv">10</span>.times <span class="kw">do</span>    <span class="co"># contains another block</span>
      explode      <span class="co"># that might raise an exception.</span>
    <span class="kw">end</span>            <span class="co"># No rescue clause here, so propagate out.</span>
  <span class="kw">rescue</span> <span class="dt">TypeError</span> <span class="co"># This rescue clause cannot handle a RuntimeError..</span>
    puts <span class="dt">$!</span>        <span class="co"># so skip it and propagate out.</span>
  <span class="kw">end</span>              
  <span class="st">&quot;hello&quot;</span>          <span class="co"># This is the normal return value, if no exception occurs.</span>
<span class="kw">end</span>                <span class="co"># No rescue clause here, so propagate up to caller.</span>

<span class="kw">def</span> defuse
  <span class="kw">begin</span>                     <span class="co"># The following code may fail with an exception.</span>
    puts risky              <span class="co"># Try to invoke print the return value.</span>
  <span class="kw">rescue</span> <span class="dt">RuntimeError</span> =&gt; e  <span class="co"># If we get an exception</span>
    puts e.message          <span class="co"># print the error message instead.</span>
  <span class="kw">end</span>                       
<span class="kw">end</span>

defuse</code></pre></div>
<h4 id="retry-in-a-rescue-clause">5.6.3.5 retry in a rescue clause</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">require <span class="st">&#39;open-uri&#39;</span>

tries = <span class="dv">0</span>       <span class="co"># How many times have we tried to read the URL</span>
<span class="kw">begin</span>           <span class="co"># This is where a retry begins</span>
  tries += <span class="dv">1</span>    <span class="co"># Try to print out the contents of a URL</span>
  open(<span class="st">&#39;http://www.example.com/&#39;</span>) {|f| puts f.readlines }
<span class="kw">rescue</span> <span class="dt">OpenURI</span>::<span class="dt">HTTPError</span> =&gt; e  <span class="co"># If we get an HTTP error</span>
  puts e.message                <span class="co"># Print the error message</span>
  <span class="kw">if</span> (tries &lt; <span class="dv">4</span>)                <span class="co"># If we haven&#39;t tried 4 times yet...</span>
    sleep(<span class="dv">2</span>**tries)             <span class="co"># Wait for 2, 4, or 8 seconds</span>
    <span class="kw">retry</span>                       <span class="co"># And then try again!</span>
  <span class="kw">end</span>
<span class="kw">end</span></code></pre></div>
<h4 id="the-ensure-clause">5.6.5 The ensure Clause</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">begin</span>
  <span class="kw">return</span> <span class="dv">1</span>     <span class="co"># Skip to the ensure clause before returning to caller</span>
<span class="kw">ensure</span>
  <span class="kw">return</span> <span class="dv">2</span>     <span class="co"># Replace the return value with this new value</span>
<span class="kw">end</span>

<span class="kw">def</span> test
  <span class="kw">begin</span> <span class="kw">return</span> <span class="dv">1</span> <span class="kw">ensure</span> <span class="dv">2</span> <span class="kw">end</span>
<span class="kw">end</span></code></pre></div>
<h4 id="rescue-with-method-class-and-module-definitions">5.6.6 rescue with Method, Class, and Module Definitions</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">def</span> method_name(x)
  <span class="co"># The body of the method goes here.</span>
  <span class="co"># Usually, the method body runs to completion without exceptions</span>
  <span class="co"># and returns to its caller normally.</span>
<span class="kw">rescue</span> 
  <span class="co"># Exception-handling code goes here.</span>
  <span class="co"># If an exception is raised within the body of the method, or if</span>
  <span class="co"># one of the methods it calls raises an exception, then control</span>
  <span class="co"># jumps to this block.</span>
<span class="kw">else</span>
  <span class="co"># If no exceptions occur in the body of the method</span>
  <span class="co"># then the code in this clause is executed.</span>
<span class="kw">ensure</span>
  <span class="co"># The code in this clause is executed no matter what happens in the</span>
  <span class="co"># body of the method. It is run if the method runs to completion, if </span>
  <span class="co"># it throws an exception, or if it executes a return statement.</span>
<span class="kw">end</span></code></pre></div>
<h4 id="rescue-as-a-statement-modifier">5.6.7 rescue As a Statement Modifier</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># Compute factorial of x, or use 0 if the method raises an exception</span>
y = factorial(x) <span class="kw">rescue</span> <span class="dv">0</span>

y = <span class="kw">begin</span>
      factorial(x)
    <span class="kw">rescue</span>
      <span class="dv">0</span>
    <span class="kw">end</span></code></pre></div>
<h4 id="begin-and-end">5.7 BEGIN and END</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">BEGIN</span> {
  <span class="co"># Global initialization code goes here</span>
}

<span class="kw">END</span> {
  <span class="co"># Global shutdown code goes here</span>
}

<span class="kw">if</span> (<span class="dv">false</span>) 
  <span class="kw">BEGIN</span> {
    puts <span class="st">&quot;if&quot;</span>;                   <span class="co"># This will be printed</span>
    a = <span class="dv">4</span>;                       <span class="co"># This variable only defined here</span>
  }
<span class="kw">else</span>
  <span class="kw">BEGIN</span> { puts <span class="st">&quot;else&quot;</span> }          <span class="co"># Also printed</span>
<span class="kw">end</span>

<span class="dv">10</span>.times {<span class="kw">BEGIN</span> { puts <span class="st">&quot;loop&quot;</span> }} <span class="co"># Only printed once</span></code></pre></div>
<h4 id="begin-and-end-1">5.7 BEGIN and END</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">a = <span class="dv">4</span>;
<span class="kw">if</span> (<span class="dv">true</span>) 
  <span class="kw">END</span> {                        <span class="co"># This END is executed</span>
    puts <span class="st">&quot;if&quot;</span>;                 <span class="co"># This code is registered</span>
    puts a                     <span class="co"># The variable is visible; prints &quot;4&quot;</span>
  }
<span class="kw">else</span>
  <span class="kw">END</span> { puts <span class="st">&quot;else&quot;</span> }          <span class="co"># This is not executed</span>
<span class="kw">end</span>
<span class="dv">10</span>.times {<span class="kw">END</span> { puts <span class="st">&quot;loop&quot;</span> }} <span class="co"># Only executed once</span></code></pre></div>
<h4 id="threads-for-concurrency">5.8.1 Threads for Concurrency</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># This method expects an array of filenames.</span>
<span class="co"># It returns an array of strings holding the content of the named files.</span>
<span class="co"># The method creates one thread for each named file.</span>
<span class="kw">def</span> readfiles(filenames)
  <span class="co"># Create an array of threads from the array of filenames.</span>
  <span class="co"># Each thread starts reading a file.</span>
  threads = filenames.map <span class="kw">do</span> |f|
    <span class="dt">Thread</span>.new { <span class="dt">File</span>.read(f) }
  <span class="kw">end</span>

  <span class="co"># Now create an array of file contents by calling the value</span>
  <span class="co"># method of each thread. This method blocks, if necessary,</span>
  <span class="co"># until the thread exits with a value.</span>
  threads.map {|t| t.value }
<span class="kw">end</span></code></pre></div>
<h4 id="fibers-for-coroutines">5.8.2 Fibers for Coroutines</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">f = <span class="dt">Fiber</span>.new {              <span class="co"># Line  1: Create a new fiber</span>
  puts <span class="st">&quot;Fiber says Hello&quot;</span>    <span class="co"># Line  2:</span>
  <span class="dt">Fiber</span>.yield                <span class="co"># Line  3: goto line 9 </span>
  puts <span class="st">&quot;Fiber says Goodbye&quot;</span>  <span class="co"># Line  4:</span>
}                            <span class="co"># Line  5: goto line 11</span>
                             <span class="co"># Line  6:</span>
puts <span class="st">&quot;Caller says Hello&quot;</span>     <span class="co"># Line  7:</span>
f.resume                     <span class="co"># Line  8: goto line 2</span>
puts <span class="st">&quot;Caller says Goodbye&quot;</span>   <span class="co"># Line  9:</span>
f.resume                     <span class="co"># Line 10: goto line 4</span>
                             <span class="co"># Line 11:</span>

<span class="dt">Caller</span> says <span class="dt">Hello</span>
<span class="dt">Fiber</span> says <span class="dt">Hello</span>
<span class="dt">Caller</span> says <span class="dt">Goodbye</span>
<span class="dt">Fiber</span> says <span class="dt">Goodbye</span></code></pre></div>
<h4 id="fiber-arguments-and-return-values">5.8.2.1 Fiber arguments and return values</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">f = <span class="dt">Fiber</span>.new <span class="kw">do</span> |message|
  puts <span class="st">&quot;Caller said: </span><span class="ot">#{</span>message<span class="ot">}</span><span class="st">&quot;</span>
  message2 = <span class="dt">Fiber</span>.yield(<span class="st">&quot;Hello&quot;</span>)    <span class="co"># &quot;Hello&quot; returned by first resume</span>
  puts <span class="st">&quot;Caller said: </span><span class="ot">#{</span>message2<span class="ot">}</span><span class="st">&quot;</span>
  <span class="st">&quot;Fine&quot;</span>                             <span class="co"># &quot;Fine&quot; returned by second resume</span>
<span class="kw">end</span>

response = f.resume(<span class="st">&quot;Hello&quot;</span>)         <span class="co"># &quot;Hello&quot; passed to block </span>
puts <span class="st">&quot;Fiber said: </span><span class="ot">#{</span>response<span class="ot">}</span><span class="st">&quot;</span>
response2 = f.resume(<span class="st">&quot;How are you?&quot;</span>) <span class="co"># &quot;How are you?&quot; returned by Fiber.yield</span>
puts <span class="st">&quot;Fiber said: </span><span class="ot">#{</span>response2<span class="ot">}</span><span class="st">&quot;</span>

<span class="dt">Caller</span> <span class="st">said: </span><span class="dt">Hello</span>
<span class="dt">Fiber</span> <span class="st">said: </span><span class="dt">Hello</span>
<span class="dt">Caller</span> <span class="st">said: </span><span class="dt">How</span> are you?
<span class="dt">Fiber</span> <span class="st">said: </span><span class="dt">Fine</span></code></pre></div>
<h4 id="implementing-generators-with-fibers">5.8.2.2 Implementing generators with fibers</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="co"># Return a Fiber to compute Fibonacci numbers</span>
<span class="kw">def</span> fibonacci_generator(x0,y0)   <span class="co"># Base the sequence on x0,y0</span>
  <span class="dt">Fiber</span>.new <span class="kw">do</span>
    x,y = x0, y0                 <span class="co"># Initialize x and y</span>
    loop <span class="kw">do</span>                      <span class="co"># This fiber runs forever</span>
      <span class="dt">Fiber</span>.yield y              <span class="co"># Yield the next number in the sequence</span>
      x,y = y,x+y                <span class="co"># Update x and y</span>
    <span class="kw">end</span>
  <span class="kw">end</span>
<span class="kw">end</span>

g = fibonacci_generator(<span class="dv">0</span>,<span class="dv">1</span>)     <span class="co"># Create a generator </span>
<span class="dv">10</span>.times { print g.resume, <span class="st">&quot; &quot;</span> } <span class="co"># And use it</span>

<span class="dv">1</span> <span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">5</span> <span class="dv">8</span> <span class="dv">13</span> <span class="dv">21</span> <span class="dv">34</span> <span class="dv">55</span>

<span class="kw">class</span> <span class="dt">FibonacciGenerator</span>
  <span class="kw">def</span> initialize
    <span class="ot">@x</span>,<span class="ot">@y</span> = <span class="dv">0</span>,<span class="dv">1</span>
    <span class="ot">@fiber</span> = <span class="dt">Fiber</span>.new <span class="kw">do</span>
      loop <span class="kw">do</span> 
        <span class="ot">@x</span>,<span class="ot">@y</span> = <span class="ot">@y</span>, <span class="ot">@x</span>+<span class="ot">@y</span>
        <span class="dt">Fiber</span>.yield <span class="ot">@x</span>
      <span class="kw">end</span>
    <span class="kw">end</span>
  <span class="kw">end</span>

  <span class="kw">def</span> <span class="kw">next</span>           <span class="co"># Return the next Fibonacci number</span>
    <span class="ot">@fiber</span>.resume
  <span class="kw">end</span>

  <span class="kw">def</span> rewind         <span class="co"># Restart the sequence</span>
    <span class="ot">@x</span>,<span class="ot">@y</span> = <span class="dv">0</span>,<span class="dv">1</span>
  <span class="kw">end</span>
<span class="kw">end</span>

g = <span class="dt">FibonacciGenerator</span>.new      <span class="co"># Create a generator</span>
<span class="dv">10</span>.times { print g.next, <span class="st">&quot; &quot;</span> }  <span class="co"># Print first 10 numbers</span>
g.rewind; puts                  <span class="co"># Start over, on a new line</span>
<span class="dv">10</span>.times { print g.next, <span class="st">&quot; &quot;</span> }  <span class="co"># Print the first 10 again</span>

<span class="kw">def</span> each
   loop { <span class="kw">yield</span> <span class="dv">self</span>.next }
<span class="kw">end</span>

<span class="kw">class</span> <span class="dt">Generator</span>
  <span class="kw">def</span> initialize(enumerable)
    <span class="ot">@enumerable</span> = enumerable  <span class="co"># Remember the enumerable object</span>
    create_fiber              <span class="co"># Create a fiber to enumerate it</span>
  <span class="kw">end</span>

  <span class="kw">def</span> <span class="kw">next</span>                    <span class="co"># Return the next element</span>
    <span class="ot">@fiber</span>.resume             <span class="co"># by resuming the fiber</span>
  <span class="kw">end</span>

  <span class="kw">def</span> rewind                  <span class="co"># Start the enumeration over</span>
    create_fiber              <span class="co"># by creating a new fiber</span>
  <span class="kw">end</span>

  <span class="kw">private</span>
  <span class="kw">def</span> create_fiber            <span class="co"># Create the fiber that does the enumeration</span>
    <span class="ot">@fiber</span> = <span class="dt">Fiber</span>.new <span class="kw">do</span>     <span class="co"># Create a new fiber</span>
      <span class="ot">@enumerable</span>.each <span class="kw">do</span> |x| <span class="co"># Use the each method</span>
        <span class="dt">Fiber</span>.yield(x)        <span class="co"># But pause during enumeration to return values</span>
      <span class="kw">end</span>              
      raise <span class="dt">StopIteration</span>     <span class="co"># Raise this when we&#39;re out of values</span>
    <span class="kw">end</span>
  <span class="kw">end</span>
<span class="kw">end</span>

g = <span class="dt">Generator</span>.new(<span class="dv">1</span>..<span class="dv">10</span>)  <span class="co"># Create a generator from an Enumerable like this</span>
loop { print g.next }     <span class="co"># And use it like an enumerator like this</span>
g.rewind                  <span class="co"># Start over like this</span>
g = (<span class="dv">1</span>..<span class="dv">10</span>).to_enum       <span class="co"># The to_enum method does the same thing</span>
loop { print g.next }</code></pre></div>
<h4 id="advanced-fiber-features">5.8.2.3 Advanced fiber features</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">
require <span class="st">&#39;fiber&#39;</span>

f = g = <span class="dv">nil</span>

f = <span class="dt">Fiber</span>.new {|x|        <span class="co"># 1: </span>
  puts <span class="st">&quot;f1: </span><span class="ot">#{</span>x<span class="ot">}</span><span class="st">&quot;</span>         <span class="co"># 2: print &quot;f1: 1&quot;</span>
  x = g.transfer(x<span class="dv">+1</span>)     <span class="co"># 3: pass 2 to line 8</span>
  puts <span class="st">&quot;f2: </span><span class="ot">#{</span>x<span class="ot">}</span><span class="st">&quot;</span>         <span class="co"># 4: print &quot;f2: 3&quot;</span>
  x = g.transfer(x<span class="dv">+1</span>)     <span class="co"># 5: return 4 to line 10</span>
  puts <span class="st">&quot;f3: </span><span class="ot">#{</span>x<span class="ot">}</span><span class="st">&quot;</span>         <span class="co"># 6: print &quot;f3: 5&quot;</span>
  x + <span class="dv">1</span>                   <span class="co"># 7: return 6 to line 13</span>
}
g = <span class="dt">Fiber</span>.new {|x|        <span class="co"># 8:</span>
  puts <span class="st">&quot;g1: </span><span class="ot">#{</span>x<span class="ot">}</span><span class="st">&quot;</span>         <span class="co"># 9: print &quot;g1: 2&quot;</span>
  x = f.transfer(x<span class="dv">+1</span>)     <span class="co">#10: return 3 to line 3</span>
  puts <span class="st">&quot;g2: </span><span class="ot">#{</span>x<span class="ot">}</span><span class="st">&quot;</span>         <span class="co">#11: print &quot;g2: 4&quot;</span>
  x = f.transfer(x<span class="dv">+1</span>)     <span class="co">#12: return 5 to line 5</span>
}
puts f.transfer(<span class="dv">1</span>)        <span class="co">#13: pass 1 to line 1</span>

<span class="st">f1: </span><span class="dv">1</span>
<span class="st">g1: </span><span class="dv">2</span>
<span class="st">f2: </span><span class="dv">3</span>
<span class="st">g2: </span><span class="dv">4</span>
<span class="st">f3: </span><span class="dv">5</span>
<span class="dv">6</span></code></pre></div>
<h4 id="continuations">5.8.3 Continuations</h4>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">require <span class="st">&#39;continuation&#39;</span>

<span class="co"># Global hash for mapping line numbers (or symbols) to continuations</span>
<span class="dt">$lines</span> = {}  

<span class="co"># Create a continuation and map it to the specified line number</span>
<span class="kw">def</span> line(symbol)
  callcc  {|c| <span class="dt">$lines</span>[symbol] = c }
<span class="kw">end</span>

<span class="co"># Look up the continuation associated with the number, and jump there</span>
<span class="kw">def</span> goto(symbol)
  <span class="dt">$lines</span>[symbol].call
<span class="kw">end</span>

<span class="co"># Now we can pretend we&#39;re programming in BASIC</span>
i = <span class="dv">0</span>
line <span class="dv">10</span>              <span class="co"># Declare this spot to be line 10</span>
puts i += <span class="dv">1</span>
goto <span class="dv">10</span> <span class="kw">if</span> i &lt; <span class="dv">5</span>     <span class="co"># Jump back to line 10 if the condition is met</span>

line <span class="dv">20</span>              <span class="co"># Declare this spot to be line 20</span>
puts i -= <span class="dv">1</span>
goto <span class="dv">20</span> <span class="kw">if</span> i &gt; <span class="dv">0</span></code></pre></div>
